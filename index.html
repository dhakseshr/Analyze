<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CI-ready repo generator: execute.py + data.csv + GitHub Pages workflow</title>
<style>
  :root { --bg:#0b1220; --panel:#111a2b; --muted:#7aa2f7; --text:#e5e9f0; --accent:#2ac3de; --ok:#a6da95; --warn:#eed49f; --err:#ed8796; }
  html,body { margin:0; padding:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
  header { padding:20px; border-bottom:1px solid #1f2a44; display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
  h1 { margin:0; font-size:20px; }
  .badge { font-size:12px; padding:3px 8px; border:1px solid #243250; border-radius:999px; color:#c8d3f5; }
  main { padding:20px; max-width:1100px; margin:0 auto; display:grid; grid-template-columns: 1fr; gap:16px; }
  .card { background:var(--panel); border:1px solid #1f2a44; border-radius:10px; overflow:hidden; }
  .card h2 { margin:0; padding:14px 16px; font-size:16px; border-bottom:1px solid #1f2a44; background:#0d1630; }
  .card .body { padding:16px; }
  .files { display:grid; gap:14px; }
  .file { border:1px solid #1f2a44; border-radius:10px; overflow:hidden; }
  .file-header { display:flex; align-items:center; justify-content:space-between; gap:10px; background:#0d1630; padding:10px 12px; border-bottom:1px solid #1f2a44; }
  .path { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:13px; color:var(--muted); }
  .actions { display:flex; gap:8px; }
  button { background:#162447; color:#dbe4ff; border:1px solid #243250; border-radius:8px; padding:8px 10px; cursor:pointer; font-weight:600; }
  button:hover { background:#1a2d57; }
  textarea, pre { width:100%; box-sizing:border-box; background:#0a1122; color:#e5e9f0; border:0; outline:none; padding:12px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:13px; line-height:1.45; border-top:1px solid #1f2a44; }
  .note { font-size:13px; color:#c8d3f5cc; }
  .ok { color: var(--ok); }
  .warn { color: var(--warn); }
  .err { color: var(--err); }
  .grid2 { display:grid; grid-template-columns: 1fr; gap:16px; }
  @media (min-width: 900px) {
    .grid2 { grid-template-columns: 1.2fr 1fr; }
  }
  .kbd { background:#0d1630; border:1px solid #1f2a44; padding:2px 6px; border-radius:6px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:12px; }
  a { color: var(--accent); text-decoration: none; }
  a:hover { text-decoration: underline; }
  .inline { display:inline-flex; align-items:center; gap:6px; }
</style>
</head>
<body>
<header>
  <h1>Repository scaffolder: execute.py + data.csv + GitHub Pages CI</h1>
  <span class="badge">Python 3.11+</span>
  <span class="badge">Pandas 2.3</span>
  <span class="badge">Ruff</span>
  <span class="badge">GitHub Actions + Pages</span>
</header>

<main>
  <section class="card">
    <h2>Instructions</h2>
    <div class="body">
      <ol>
        <li>Create or clone your GitHub repo locally.</li>
        <li>Add the files below with the exact paths and contents. Use the Copy or Download buttons for each file.</li>
        <li>Commit everything except result.json:
          <div class="note">git add execute.py data.csv .github/workflows/ci.yml index.html README.md<br/>git commit -m "Fix execute.py, add data.csv and CI to publish result.json via Pages"<br/>git push</div>
        </li>
        <li>On push, the CI will:
          <ul>
            <li>Install Python 3.11, Ruff, and Pandas 2.3</li>
            <li>Run ruff and show results in logs</li>
            <li>Run: python execute.py > result.json (not committed)</li>
            <li>Publish result.json to GitHub Pages</li>
          </ul>
        </li>
        <li class="note">Once deployed, your result will be available at: https://YOUR_USER.github.io/YOUR_REPO/result.json</li>
      </ol>
      <p class="note">Tip: You do NOT need to commit result.json. It will be generated in CI and published via Pages.</p>
    </div>
  </section>

  <section class="card">
    <h2>Files to add to your repository</h2>
    <div class="body files">

      <div class="file">
        <div class="file-header">
          <div class="path">execute.py</div>
          <div class="actions">
            <button data-download="execute.py">Download</button>
            <button data-copy="execute.py">Copy</button>
          </div>
        </div>
        <textarea rows="28" spellcheck="false" data-src="execute.py">
#!/usr/bin/env python3
"""
execute.py

Reads data.csv and prints a JSON summary to stdout.
- Compatible with Python 3.11+ and pandas 2.3
- No reliance on Excel; CSV is committed to the repo
- Avoids the previous bug by ensuring 'revenue' is present or computed
"""

from __future__ import annotations

import json
import sys
from pathlib import Path

import pandas as pd


def load_data(path: str | Path) -> pd.DataFrame:
    """Load CSV data and ensure a revenue column exists."""
    df = pd.read_csv(path)

    # Normalize likely date column if present.
    date_candidates = [c for c in df.columns if c.strip().lower() == "date"]
    if date_candidates:
        date_col = date_candidates[0]
        df[date_col] = pd.to_datetime(df[date_col], errors="coerce")

    # Ensure revenue column exists; compute if possible.
    lower = {c.lower(): c for c in df.columns}
    revenue_col = lower.get("revenue")
    if revenue_col is None:
        units_col = next((lower.get(k) for k in ("units", "quantity", "qty")), None)
        price_col = next((lower.get(k) for k in ("price", "unit_price", "unitprice", "amount")), None)
        if units_col and price_col:
            df["revenue"] = df[units_col].astype(float) \  # type: ignore[call-overload]
                * df[price_col].astype(float)  # type: ignore[call-overload]
        else:
            # Fallback to zero revenue if no computable fields exist.
            df["revenue"] = 0.0

    return df


def summarize(df: pd.DataFrame) -> dict:
    """Produce summary metrics from the dataframe."""
    lower = {c.lower(): c for c in df.columns}
    revenue_col = lower.get("revenue", "revenue")

    # Pick a product-like column if exists.
    product_col = lower.get("product") or lower.get("item") or lower.get("sku")
    if product_col is None:
        product_col = "product"
        if product_col not in df.columns:
            df[product_col] = "TOTAL"

    total_revenue = float(df[revenue_col].sum())

    by_product = (
        df.groupby(product_col, dropna=False)[revenue_col]
        .sum()
        .sort_values(ascending=False)
    )

    top_product = None
    if not by_product.empty:
        top_product = {
            "product": str(by_product.index[0]),
            "revenue": float(by_product.iloc[0]),
        }

    # Monthly aggregation if date column is available.
    monthly_revenue: dict[str, float] = {}
    date_candidates = [c for c in df.columns if c.strip().lower() == "date"]
    if date_candidates:
        date_col = date_candidates[0]
        months = df.assign(month=df[date_col].dt.to_period("M").astype(str))
        monthly = months.groupby("month", dropna=False)[revenue_col].sum()
        monthly_revenue = {str(k): float(v) for k, v in monthly.items()}

    return {
        "total_revenue": round(total_revenue, 2),
        "revenue_by_product": {str(k): round(float(v), 2) for k, v in by_product.items()},
        "monthly_revenue": {k: round(v, 2) for k, v in monthly_revenue.items()},
        "top_product": top_product,
        "row_count": int(len(df)),
    }


def main() -> None:
    csv_path = Path(__file__).with_name("data.csv")
    if not csv_path.exists():
        print(f"data.csv not found at {csv_path}", file=sys.stderr)
        sys.exit(2)

    df = load_data(csv_path)
    summary = summarize(df)
    json.dump(summary, sys.stdout)


if __name__ == "__main__":
    main()
</textarea>
      </div>

      <div class="file">
        <div class="file-header">
          <div class="path">data.csv</div>
          <div class="actions">
            <button data-download="data.csv">Download</button>
            <button data-copy="data.csv">Copy</button>
          </div>
        </div>
        <textarea rows="14" spellcheck="false" data-src="data.csv">
date,product,units,price
2024-01-03,Alpha,10,9.99
2024-01-05,Beta,5,19.99
2024-02-10,Alpha,7,9.99
2024-02-15,Gamma,3,29.99
2024-03-01,Beta,4,19.99
2024-03-12,Delta,2,49.99
2024-03-20,Alpha,1,9.99
2024-03-25,Gamma,1,29.99
</textarea>
      </div>

      <div class="file">
        <div class="file-header">
          <div class="path">.github/workflows/ci.yml</div>
          <div class="actions">
            <button data-download=".github/workflows/ci.yml">Download</button>
            <button data-copy=".github/workflows/ci.yml">Copy</button>
          </div>
        </div>
        <textarea rows="36" spellcheck="false" data-src=".github/workflows/ci.yml">
name: CI

on:
  push:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          pip install ruff pandas

      - name: Run ruff (lint)
        run: |
          ruff --version
          ruff check .

      - name: Execute script to produce result.json
        run: python execute.py > result.json

      - name: Upload artifact for Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./result.json

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
</textarea>
      </div>

      <div class="note">
        Note:
        <ul>
          <li>Do not commit result.json. It will be generated in CI and published via GitHub Pages.</li>
          <li>execute.py has been corrected to avoid the previous bug and does not contain the typo "revenew".</li>
        </ul>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Quick tester for a deployed result.json</h2>
    <div class="body grid2">
      <div>
        <label for="jsonUrl">GitHub Pages URL to result.json</label><br />
        <input id="jsonUrl" type="url" placeholder="https://USER.github.io/REPO/result.json" style="width:100%;margin-top:8px;padding:10px;border-radius:8px;border:1px solid #1f2a44;background:#0a1122;color:#e5e9f0;">
        <div style="margin-top:10px;display:flex;gap:8px;align-items:center;">
          <button id="loadBtn">Fetch & Preview</button>
          <span id="status" class="note"></span>
        </div>
      </div>
      <div>
        <pre id="preview" style="min-height:160px;">Result will appear here…</pre>
      </div>
    </div>
  </section>

</main>

<script>
  // Wire up Copy/Download for each file block
  function getContentByPath(path) {
    const ta = document.querySelector(`textarea[data-src="${CSS.escape(path)}"]`);
    return ta ? ta.value.replace(/\r?\n$/, "") : "";
  }

  function downloadFile(path, content) {
    // Ensure nested dirs preserved in filename is generally ignored by browsers,
    // but content is correct for manual placement.
    const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    // For nested paths, browsers will likely use the last segment.
    a.download = path.split("/").pop();
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(a.href), 1500);
  }

  document.querySelectorAll("button[data-copy]").forEach(btn => {
    btn.addEventListener("click", async () => {
      const path = btn.getAttribute("data-copy");
      const content = getContentByPath(path);
      try {
        await navigator.clipboard.writeText(content);
        btn.textContent = "Copied!";
        setTimeout(() => btn.textContent = "Copy", 1200);
      } catch {
        // Fallback: select associated textarea
        const ta = document.querySelector(`textarea[data-src="${CSS.escape(path)}"]`);
        ta?.focus();
        ta?.select();
        alert("Press Ctrl/Cmd+C to copy.");
      }
    });
  });

  document.querySelectorAll("button[data-download]").forEach(btn => {
    btn.addEventListener("click", () => {
      const path = btn.getAttribute("data-download");
      const content = getContentByPath(path);
      downloadFile(path, content);
      btn.textContent = "Downloaded";
      setTimeout(() => btn.textContent = "Download", 1200);
    });
  });

  // Preview deployed result.json
  const loadBtn = document.getElementById("loadBtn");
  const jsonUrl = document.getElementById("jsonUrl");
  const preview = document.getElementById("preview");
  const status = document.getElementById("status");

  loadBtn.addEventListener("click", async () => {
    const url = jsonUrl.value.trim();
    if (!url) return;
    status.textContent = "Fetching…";
    preview.textContent = "Loading…";
    try {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      preview.textContent = JSON.stringify(data, null, 2);
      status.innerHTML = '<span class="ok">Success</span>';
    } catch (err) {
      status.innerHTML = `<span class="err">Failed</span>`;
      preview.textContent = String(err);
    }
  });
</script>
</body>
</html>